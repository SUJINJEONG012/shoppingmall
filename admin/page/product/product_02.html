<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상품등록</title>
    <link rel="icon" type="image/png" sizes="32x32" href="../../../images/common/favicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css" />
    <link rel="stylesheet" href="../../../css/reset.css">
    <link rel="stylesheet" href="../../css/layout.css">
    <link rel="stylesheet" href="../../css/main.css">

    <script src="../../js/index.js" defer></script>
</head>

<body>

    <header class="admin-header">

        <div class="top-menu inner">
            <h1 class="logo"><a href="../../index.html" lang="en">SLOM`ANGE</a></h1>
            <nav>
                <ul class="tabs">
                    <li><a href="../../index.html"><i class="fas fa-home"></i>홈</a></li>

                    <li class="active"><a href="../../page/product/product_01.html"><i
                                class="fas fa-tshirt"></i>상품관리</a></li>
                    <li><a href="../../page/order/order_01.html"><i class="fas fa-shopping-cart"></i>주문관리</a></li>
                    <li><a href="../../page/member/member_01.html"><i class="fas fa-user"></i>회원관리</a></li>
                    <li><a href="../../page/board/board_01.html"><i class="fas fa-clipboard"></i>게시판관리</a></li>
                </ul>
            </nav>
        </div>

    </header>



    <div class="container-wrap">

        <div class="inner">
            <div class="sidebar">
                <div id="product" data-tab-content class="active">
                    <ul class="depth-menu">
                        <li class="big-title"><i class="fas fa-tshirt"></i>상품관리</li>
                        <li><a href="./product_01.html">분류관리</a></li>
                        <li class="active"><a href="./product_02.html">상품등록</a></li>
                        <li><a href="./product_03.html">상품목록</a></li>
                    </ul>
                </div>



            </div>

            <div class="content">
                <div class="cont-inner">
                    <div class="item-area">

                        <div class="item-cont product">
                            <h2 class="title">상품 등록</h2>


                            <form name="" id="" action="" onsubmit="" method="" enctype="" autocomplete="off">

                                <div class="prod_cate">

                                    <select class="sel_cate" id="main_cate" onchange="categorySelect(this)">
                                        <option value="none">=== 대분류선택 ===</option>
<!--                                        <option value="tshirt">티셔츠</option>-->
<!--                                        <option value="mantoman">맨투맨</option>-->
<!--                                        <option value="hood">후디</option>-->
<!--                                        <option value="outer">아우터</option>-->
<!--                                        <option value="pant">바지</option>-->
<!--                                        <option value="dress">원피스/스커트</option>-->
<!--                                        <option value="blouse">셔츠/블라우스</option>-->
<!--                                        </option>-->

                                    </select>

                                    <select id="type2" class="sel_cate">
                                        <option>대분류 카테고리를 선택해주세요</option>
                                    </select>

                                </div>




                                <script>
                                    function categoryChange(e) {
                                        let op1 = ["선택해주세요", "반팔티", "긴팔티"];
                                        let op2 = ["선택해주세요", "아노락", "풀오버"];
                                        let op3 = ["선택해주세요", "풀오버", "집업"];
                                        let op4 = ["선택해주세요", "점퍼", "패딩", "자켓", "코트"];
                                        let op5 = ["선택해주세요", "슬랙스", "트레이닝", "쇼츠", "데님"];
                                        let op6 = ["선택해주세요", "원피스", "스커트"];
                                        let op7 = ["선택해주세요", "셔츠", "옥스퍼드", "블라우스"];


                                        let target = document.getElementById("type2");


                                        if (e.value == "tshirt") {
                                            var type = op1;
                                        }
                                        else if (e.value == "mantoman") {
                                            var type = op2;
                                        }
                                        else if (e.value == "hood") {
                                            var type = op3;
                                        }
                                        else if (e.value == "outer") {
                                            var type = op4;
                                        }
                                        else if (e.value == "pant") {
                                            var type = op5;
                                        }
                                        else if (e.value == "dress") {
                                            var type = op6;
                                        }
                                        else if (e.value == "blouse") {
                                            var type = op7;
                                        }
                                        target.options.length = 0;

                                        for (const prodType in type) {
                                            let opt = document.createElement("option");
                                            opt.value = type[prodType]; opt.innerHTML = type[prodType]; target.appendChild(opt);
                                        }
                                    }

                                </script>


                                <div class="bo_w_tit write_div">
                                    <label for="wr_subject" class="sound_only">제목<strong>필수</strong></label>

                                    <div id="autosave_wrapper" class="write_div">
                                        <input type="text" name="wr_subject" value="" id="wr_subject" required=""
                                            class="frm_input full_input required" size="50" maxlength="255"
                                            placeholder="제목">
                                        <input type="text" name="wr_price" id="wr_price" placeholder="가격(원)">

                                    </div>

                                </div>

                                <div id="editor">
                                    <p>This is some sample content.</p>
                                </div>


                                <div class="file_wr write_div">
                                    <label for="bf_file_1" class="lb_icon"><i class="fa fa-folder-open"
                                            aria-hidden="true"></i><span class="sound_only"> 파일 #1</span></label>
                                    <input type="file" name="bf_file[]" id="bf_file_1"
                                        title="파일첨부 1 : 용량 1,048,576 바이트 이하만 업로드 가능" class="frm_file ">
                                </div>


                                <div class="btn_confirm write_div">
                                    <a href="https://demo.sir.kr/gnuboard5/bbs/board.php?bo_table=board"
                                        class="btn_cancel btn">취소</a>
                                    <button type="button" id="btn_submit" accesskey="s"
                                        class="btn_submit btn">작성완료</button>
                                </div>
                            </form>


                        </div>

                    </div>
                </div>

            </div>
            <!-- content -->

        </div>
        <!-- inner -->
    </div>
    <!-- container-wrap -->

    <!-- 에디터 -->
    <script src="https://cdn.ckeditor.com/ckeditor5/34.2.0/classic/ckeditor.js"></script>
    <script>

        /**
         * 에디터 관련
         * */
        let myEditor

        ClassicEditor
            .create(document.querySelector('#editor'),{
                ckfinder:{
                    uploadUrl: 'http://121.145.8.135:8080/v1/api/file/image'
                }
            })
            .then(editor => {
                myEditor = editor;
            })
            .catch(error => {
                console.error(error);
            });

        /**
         * 입력한 숫자에 콤마 넣기
         * */
        const priceInput = document.getElementById('wr_price');
        priceInput.addEventListener('keyup', ev => {
           let value = ev.target.value;
           value = Number(value.replaceAll(',',''));
           if(isNaN(value)){
               priceInput.value = 0;
           } else {
               priceInput.value = value.toLocaleString();
           }
        });

        /**
         * 상품 등록
         * */
        const buttonEvent = document.getElementById('btn_submit');

        buttonEvent.addEventListener('click', () => {
            let title = document.getElementById("wr_subject").value;
            let content = myEditor.getData();
            let selectedFile = document.getElementById("bf_file_1").files[0];
            let categoryIdx = document.getElementById('type2').value;
            let price = document.getElementById('wr_price').value;
            price = Number(price.replaceAll(',',''));

            console.log(price);
            console.log(title);
            console.log(content);
            console.log(selectedFile);
            console.log(categoryIdx);

            if(isNaN(price)) return;

            let option = ["Beige", "Black"];

            let formData = new FormData();
            formData.append("name", title);
            formData.append("content", content);
            formData.append("categoryIdx", categoryIdx);
            formData.append("price", price);

            option.forEach(e => {
                formData.append("option", e);
            });

            if (selectedFile !== undefined) {
                formData.append("file", selectedFile);
            }

            let accessToken = localStorage.getItem('accessToken');

            fetch("http://121.145.8.135:8080/v1/api/admin/product", {
                method: "POST",
                // headers: {
                //     "Authorization": `Bearer ${accessToken}`
                // },
                body: formData,
            })
                .then((res) => res.json())
                .then((res) => {
                    if (res.code === 200) {
                        console.log(res.content);
                        location.href = 'product_03.html';
                    } else {
                        if (res.status === 401) {
                            alert("로그인 시간이 만료되었습니다. 다시 로그인 해주세요");
                            localStorage.removeItem('accessToken');
                            location.href = "../../../page/login.html";
                        } else {
                            console.log(res);
                            alert("공지사항 등록에 실패하셨습니다. 다시 시도해주세요");
                        }
                    }
                });

        });


        /**
         * categoryList : 대분류 리스트
         * categoryRender : 카테고리 view 렌더링
         * categorySelect : 대분류 선택했을때 해당 대분류에 맞는 소분류 카테고리 리스트 보여주기
         * */
        let categoryList;

        let categoryRender = (category, dom) => {
            let html = `<option value="${category.idx}">${category.name}</option>`
            dom.insertAdjacentHTML("beforeend", html);
        }

        let categorySelect = (e) => {
            let subCate = document.getElementById('type2');
            while (subCate.hasChildNodes()){
                subCate.removeChild(subCate.firstChild);
            }

            if(e.value === 'none') {
                categoryRender({idx : 0, name : '대분류 카테고리를 선택해주세요'}, subCate);
                return;
            }

            let subCateList;

            categoryList.forEach((category)=>{
               if(parseInt(e.value) === category.idx){
                   subCateList = category.subCategory;
                   return false;
               }
            });

            categoryRender({idx : 0, name : '선택해주세요'}, subCate);

            subCateList.forEach((subCategory)=>{
               categoryRender(subCategory, subCate);
            });

        }

        /**
         * 페이지 보여줄 때 필요한 데이터 받아오기
         * 상품등록 페이지에서는 카테고리 리스트가 필요
         * */
        window.onload = () => {
            fetch("http://121.145.8.135:8080/v1/api/product/category", {
                method: "GET",
            })
                .then((res) => res.json())
                .then((res) => {
                    if(res.code === 200){
                        console.log(res.content);
                        categoryList = res.content;
                        let mainCate = document.getElementById('main_cate');
                        res.content.forEach((category)=>{
                           categoryRender(category, mainCate);
                        });
                    } else {
                        alert('다시 시도해주세요');
                    }
                })
        }
    </script>




</body>

</html>